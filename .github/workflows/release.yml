name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Restore
        run: dotnet restore

      - name: Run tests
        run: dotnet test RevitTranslator.Tests/RevitTranslator.Tests.csproj --no-restore

      - name: Build Release R23
        run: dotnet build -c "Release R23" --no-restore -p:Version=${{ steps.version.outputs.VERSION }}

      - name: Build Release R24
        run: dotnet build -c "Release R24" --no-restore -p:Version=${{ steps.version.outputs.VERSION }}

      - name: Build Release R25
        run: dotnet build -c "Release R25" --no-restore -p:Version=${{ steps.version.outputs.VERSION }}

      - name: Build Release R26
        run: dotnet build -c "Release R26" --no-restore -p:Version=${{ steps.version.outputs.VERSION }}

      - name: Generate MSI installers
        working-directory: Installer
        run: dotnet run --project Installer.csproj
        env:
          CI: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            Installer/Installer/Revit_Translator_V23.msi
            Installer/Installer/Revit_Translator_V24.msi
            Installer/Installer/Revit_Translator_V25.msi
            Installer/Installer/Revit_Translator_V26.msi

      - name: Generate appcast files
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $tag = "v$version"
          $baseUrl = "https://github.com/Krachkovskii/RevitTranslator/releases/download/$tag"
          $pubDate = (Get-Date).ToUniversalTime().ToString("ddd, dd MMM yyyy HH:mm:ss +0000")

          foreach ($rv in @(23, 24, 25, 26)) {
            $msiName = "Revit_Translator_V${rv}.msi"
            $msiPath = "Installer/Installer/$msiName"
            $url = "$baseUrl/$msiName"
            $size = (Get-Item $msiPath).Length

            $xml = @"
<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
  <channel>
    <title>Revit Translator</title>
    <link>https://github.com/Krachkovskii/RevitTranslator</link>
    <description>Machine translation for Revit models using DeepL API</description>
    <language>en-us</language>
    <item>
      <title>Version $version</title>
      <pubDate>$pubDate</pubDate>
      <sparkle:releaseNotesLink>https://github.com/Krachkovskii/RevitTranslator/releases/tag/$tag</sparkle:releaseNotesLink>
      <enclosure
        url="$url"
        sparkle:version="$version"
        sparkle:os="windows"
        type="application/x-msi"
        length="$size" />
    </item>
  </channel>
</rss>
"@
            $xml | Out-File -FilePath "appcast-R${rv}.xml" -Encoding utf8NoBOM
          }

      - name: Commit appcast files to main
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git pull origin main
          git add appcast-R23.xml appcast-R24.xml appcast-R25.xml appcast-R26.xml
          git commit -m "chore: update appcast for ${{ github.ref_name }}"
          git push origin main
